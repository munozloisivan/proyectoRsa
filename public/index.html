<!doctype html>
<html lang="en" ng-app="RSA">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RSA</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.min.js"></script>
    <script src="http://peterolson.github.com/BigInteger.js/BigInteger.min.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1/build/rollups/sha256.js"></script>
    <script>
        var hash = CryptoJS.SHA256("Message");
    </script>
    <script>


        $(document).ready (function(){
            $("#success-alert").hide();
            $("#changekey-alert").hide();
            $("#sign-alert").hide();

            var hash = CryptoJS.MD5("Message");

            console.log(hash);
        });

        var app = angular.module('RSA', []);

        app.controller('mainController', function($scope, $http) {

            var id_o = "Cliente";
            var id_d;

            $http.get("/rsa/pukey").success(function(response) {
                $scope.expE = response.e;
                $scope.modN = response.n;
                id_d = response.id;
            });

            $scope.redoKey = function () {
                $http.get("/rsa/redokey").success(function (response) {
                    $scope.change_status = response.status;
                    $("#changekey-alert").fadeTo(3000, 500).slideUp(500, function(){
                        $("#changekey-alert").slideUp(500);
                    });
                    $http.get("/rsa/pukey").success(function(response) {
                        $scope.expE = response.e;
                        $scope.modN = response.n;
                        id_d = response.id;
                    });
                })
            }

            $scope.send = function () {
                console.log("DESCIFRAR");
                console.log("Mensaje: " + $scope.mensaje);
                var input = String2Hex($scope.mensaje);
                console.log("Hexadecimal: " + input);
                var bnumber = bigInt(input, 16);
                console.log("Big-int del hexa: " + bnumber);
                var cipher = bigInt(bnumber).modPow($scope.expE, $scope.modN).toString();
                var dataObj = ([{"A": id_o}, {"B": id_d}, {"cipher": cipher}]);

                var po; //Hash de dataObj
                var enviar; //dataobject + po

                var data = JSON.stringify(dataObj);
                    $http.post("/rsa/send", data)
                        .success(function (response) {
                            $scope.send_status = response.status;
                            $("#success-alert").fadeTo(3000, 500).slideUp(500, function(){
                                $("#success-alert").slideUp(500);
                            });
                        })
            }

            $scope.sendToSign = function () {
                console.log("FIRMAR");
                var length = 512;
                console.log("Mensaje: " + $scope.mensaje_to_sign);
                var b = createBlinder(length);
                var blinder_factor = bigInt(b).modPow($scope.expE, $scope.modN);
                console.log("Factor de cegado: " + blinder_factor.toString());
                var b_inv = bigInt(b).modInv($scope.modN);
                console.log("Factor de descegado: " + b_inv.toString());
                var input = String2Hex($scope.mensaje_to_sign);
                console.log("Hexadecimal: " + input);
                var bnumber = bigInt(input, 16);
                console.log("Big-int del hexadecimal: " + bnumber);
                var blinded = ((bigInt(bnumber).multiply(blinder_factor)).mod($scope.modN)).toString();
                console.log("Blinded: " + blinded);
                var dataObj = ([{"A": id_o}, {"B": id_d}, {"blinded": blinded}]);
                var data = JSON.stringify(dataObj);
                    $http.post("/rsa/sign", data)
                        .success(function (response) {
                            $scope.sign_status = response[3].status;
                            $("#sign-alert").fadeTo(3000, 500).slideUp(500, function(){
                                $("#sign-alert").slideUp(500);
                            });
                            $scope.signed_msg_blind = response[2].signed;
                            console.log("Firmado cegado: " + response[2].signed);
                            var signed_final_blind = bigInt($scope.signed_msg_blind);
                            var signed_final = (bigInt(signed_final_blind).multiply(b_inv)).mod($scope.modN);
                            console.log("Firmado: " + signed_final.toString());
                            $scope.signed_msg = signed_final.toString();
                            var probe_hexa = bigInt(signed_final).modPow($scope.expE, $scope.modN);
                            var probe = hex_to_ascii(probe_hexa.toString(16));
                            console.log(response);
                            console.log("Comprobación: " + probe);
                        })
            };

            function String2Hex(tmp) {
                var str = '';
                for(var i = 0; i < tmp.length; i++) {
                    str += tmp[i].charCodeAt(0).toString(16);
                }
                return str;
            }

            function hex_to_ascii(str1)
            {
                var hex  = str1.toString();
                var str = '';
                for (var n = 0; n < hex.length; n += 2) {
                    str += String.fromCharCode(parseInt(hex.substr(n, 2), 16));
                }
                return str;
            }

            function createBlinder(length){
                //Factor de cegado
                var b = bigInt.randBetween((bigInt(2).pow(length/2)), bigInt($scope.modN));
                while ((!bigInt(b).isPrime())&&(bigInt.lcm(b, $scope.modN) != 1)){
                    b = bigInt.randBetween((bigInt(2).pow(length/2)), bigInt($scope.modN));
                }
                return b;
            }
        });

    </script>

</head>

<body ng-controller="mainController" style="background-color: #f5f5ef">

<div class="container-fluid">
    <h3 align="center">Exponente público (e)</h3><p style="font-size: 15px; font-family: Consolas" align="center">{{ expE }}</p>
    <h3 align="center">Módulo (n)</h3><p style="font-size: 15px; font-family: Consolas" align="center">{{ modN }}</p>

    <div style="text-align: center">
        <button type="button" class="btn btn-danger" ng-click = "redoKey()">Restaurar claves</button>
    </div>

    <div class="alert alert-success" id="success-alert" style="margin-top: 20px;" align="center">
        <strong>{{send_status}}</strong>
    </div>
    <div class="alert alert-info" id="changekey-alert" style="margin-top: 20px;" align="center">
        <strong>{{change_status}}</strong>
    </div>
    <div class="alert alert-info" id="sign-alert" style="margin-top: 20px;" align="center">
        <strong>{{sign_status}}</strong>
    </div>
</div>

<div class="container-fluid col-md-12" style="margin: 0 auto; padding-top: 50px">

    <div class="container-fluid col-md-6" style="background-color: #d7d7c1; padding: 20px; border-radius: 20px">
        <form ng-submit = "send()">
            <label>Mensaje para descifrar:</label>
            <input style="width: 100%;" ng-model="mensaje" required>
            <button style="margin-top: 10px" type="submit" class="btn btn-primary">Envíar al servidor</button>
        </form>
        <br>
        <form ng-submit = "sendToSign()">
            <label>Mensaje para firmar:</label>
            <input style="width: 100%;" ng-model="mensaje_to_sign" required>
            <button style="margin-top: 10px" type="submit" class="btn btn-primary">Envíar para firmar</button>
        </form>
    </div>

    <div class="container-fluid col-md-12" style="padding: 20px; border-radius: 20px">
        <h3>Mensaje firmado cegado:</h3>
        <p style="font-size: 15px; font-family: Consolas" align="center">{{ signed_msg_blind }}</p>
        <h3>Mensaje firmado:</h3>
        <p style="font-size: 15px; font-family: Consolas" align="center">{{ signed_msg }}</p>
    </div>
</div>

</body>
</html>